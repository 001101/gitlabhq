#!/usr/bin/env ruby

require 'json'
require 'time'

def days_from_now(days)
  Time.now - (3600 * 24 * days)
end

report_file = ARGV.shift
unless report_file
  puts 'usage: prune-old-flaky-specs <report-file> <new-report-file>'
  exit 1
end

new_report_file = ARGV.shift || report_file

puts "Loading #{report_file}..."
report = JSON.parse(File.read(report_file))
old_report_size = report.size

puts "Current report has #{report.size} entries."

report.delete_if { |uid, hash| Time.parse(hash['last_flaky_at']).to_i < days_from_now(90).to_i }

puts "New report has #{report.size} entries: #{old_report_size - report.size} entries older than 90 days were removed."

File.write(new_report_file, JSON.pretty_generate(report))
puts "Saved #{new_report_file}."
