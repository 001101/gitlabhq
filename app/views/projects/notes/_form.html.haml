- supports_slash_commands = note_supports_slash_commands?(@note)
- new_discussion = !params.fetch(:new_discussion, 0).to_i.zero?

= form_for [@project.namespace.becomes(Namespace), @project, @note], remote: true, html: { :'data-type' => 'json', multipart: true, id: nil, class: "new-note js-new-note-form js-quick-submit common-note-form", "data-noteable-iid" => @note.noteable.try(:iid), }, authenticity_token: true do |f|
  = hidden_field_tag :view, diff_view
  = hidden_field_tag :line_type
  = hidden_field_tag :merge_request_diff_head_sha, @note.noteable.try(:diff_head_sha)
  = hidden_field_tag :in_reply_to_discussion_id

  = note_target_fields(@note)
  = f.hidden_field :noteable_type, value: "#{'DiscussionNote' if new_discussion}"
  = f.hidden_field :noteable_id
  = f.hidden_field :commit_id
  = f.hidden_field :type

  -# LegacyDiffNote
  = f.hidden_field :line_code

  -# DiffNote
  = f.hidden_field :position

  = render layout: 'projects/md_preview', locals: { preview_class: "md-preview", referenced_users: true } do
    = render 'projects/zen', f: f,
      attr: :note,
      classes: 'note-textarea js-note-text',
      placeholder: "Write a comment or drag your files here...",
      supports_slash_commands: supports_slash_commands
    = render 'projects/notes/hints', supports_slash_commands: supports_slash_commands
    .error-alert

  .note-form-actions.clearfix
    .btn-group.append-right-10.comment-type-dropdown.js-comment-type-dropdown
      = f.submit "#{ new_discussion && @note.can_be_discussion_note? ? 'Start discussion' : 'Comment' }", class: "btn btn-nr btn-create comment-btn js-comment-button js-comment-submit-button"
      - if @note.can_be_discussion_note?
        = button_tag type: 'button', class: 'btn btn-nr dropdown-toggle comment-btn js-comment-button js-note-new-discussion', data: { 'dropdown-trigger' => '.dropdown-menu' } do
          = icon('caret-down')
        %ul.dropdown-menu{ data: { dropdown: true } }
          %li#comment{ data: { value: '', 'button-text' => 'Comment' }, class: "#{ 'droplab-item-selected' unless new_discussion }" }
            = icon('check')
            .description
              %strong Comment
              %p Add a general comment to this merge request.
          %hr
          %li#discussion{ data: { value: 'DiscussionNote', 'button-text' => 'Start discussion' }, class: "#{ 'droplab-item-selected' if new_discussion }" }
            = icon('check')
            .description
              %strong Start discussion
              %p Discuss a specific suggestion or question that needs to be resolved.

    = yield(:note_actions)

    %a.btn.btn-cancel.js-note-discard{ role: "button", data: {cancel_text: "Cancel" } }
      Discard draft
