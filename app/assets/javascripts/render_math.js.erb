// Renders math using KaTeX
(function() {
  // CSS and JS for KaTeX
  var CSS_PATH = "<%= asset_path('katex.css') %>";
  var JS_PATH = "<%= asset_path('katex.js') %>";

  // Only load once
  var katexLoaded = false;

  // Loop over all math elements and render math
  var renderWithKaTeX = function (elements) {
    elements.each(function () {
      var mathNode = $( "<span></span>" );
      var $this = $(this);

      var display = $this.attr('data-math-style') === 'display';
      try {
        katex.render($this.text(), mathNode.get(0), { displayMode: display });
        mathNode.insertAfter($this);
        $this.remove();
      } catch (err) {
        // What can we do??
        console.log(err.message);
      }
    });
  };

  $.fn.renderMath = function() {
    var $this = $(this);
    if (katexLoaded) renderWithKaTeX($this);
    else {
      // Request CSS file so it is in the cache
      $.get(CSS_PATH, function(){
        var css = $('<link>',
            {rel:'stylesheet',
              type:'text/css',
              href: CSS_PATH
            });
        css.appendTo('head');

        // Load KaTeX js
        $.getScript(JS_PATH, function() {
          katexLoaded = true;
          renderWithKaTeX($this); // Run KaTeX
        })
      });
    }
  }

}).call(this);
